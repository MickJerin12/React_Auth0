{"ast":null,"code":"import _classCallCheck from \"/Users/mickjerin/Securing React/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/mickjerin/Securing React/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport auth0 from \"auth0-js\";\nvar REDIRECT_ON_LOGIN = \"redirect_on_login\"; // Stored outside class since private\n// eslint-disable-next-line\n\nvar _idToken = null;\nvar _accessToken = null;\nvar _scopes = null;\nvar _expiresAt = null;\n\nvar Auth = /*#__PURE__*/function () {\n  function Auth(history) {\n    var _this = this;\n\n    _classCallCheck(this, Auth);\n\n    this.login = function () {\n      localStorage.setItem(REDIRECT_ON_LOGIN, JSON.stringify(_this.history.location));\n\n      _this.auth0.authorize();\n    };\n\n    this.handleAuthentication = function () {\n      _this.auth0.parseHash(function (err, authResult) {\n        if (authResult && authResult.accessToken && authResult.idToken) {\n          _this.setSession(authResult);\n\n          var redirectLocation = localStorage.getItem(REDIRECT_ON_LOGIN) === \"undefined\" ? \"/\" : JSON.parse(localStorage.getItem(REDIRECT_ON_LOGIN));\n\n          _this.history.push(redirectLocation);\n        } else if (err) {\n          _this.history.push(\"/\");\n\n          alert(\"Error: \".concat(err.error, \". Check the console for further details.\"));\n          console.log(err);\n        }\n\n        localStorage.removeItem(REDIRECT_ON_LOGIN);\n      });\n    };\n\n    this.setSession = function (authResult) {\n      console.log(authResult); // set the time that the access token will expire\n\n      _expiresAt = authResult.expiresIn * 1000 + new Date().getTime(); // If there is a value on the `scope` param from the authResult,\n      // use it to set scopes in the session for the user. Otherwise\n      // use the scopes as requested. If no scopes were requested,\n      // set it to nothing\n\n      _scopes = authResult.scope || _this.requestedScopes || \"\";\n      _accessToken = authResult.accessToken;\n      _idToken = authResult.idToken;\n\n      _this.scheduleTokenRenewal();\n    };\n\n    this.logout = function () {\n      _this.auth0.logout({\n        clientID: process.env.REACT_APP_AUTH0_CLIENT_ID,\n        returnTo: \"http://localhost:3000\"\n      });\n    };\n\n    this.getAccessToken = function () {\n      if (!_accessToken) {\n        throw new Error(\"No access token found.\");\n      }\n\n      return _accessToken;\n    };\n\n    this.getProfile = function (cb) {\n      if (_this.userProfile) return cb(_this.userProfile);\n\n      _this.auth0.client.userInfo(_this.getAccessToken(), function (err, profile) {\n        if (profile) _this.userProfile = profile;\n        cb(profile, err);\n      });\n    };\n\n    this.history = history;\n    this.userProfile = null;\n    this.requestedScopes = \"openid profile email read:courses\";\n    this.auth0 = new auth0.WebAuth({\n      domain: process.env.REACT_APP_AUTH0_DOMAIN,\n      clientID: process.env.REACT_APP_AUTH0_CLIENT_ID,\n      redirectUri: process.env.REACT_APP_AUTH0_CALLBACK_URL,\n      audience: process.env.REACT_APP_AUTH0_AUDIENCE,\n      responseType: \"token id_token\",\n      scope: this.requestedScopes\n    });\n  }\n\n  _createClass(Auth, [{\n    key: \"isAuthenticated\",\n    value: function isAuthenticated() {\n      return new Date().getTime() < _expiresAt;\n    }\n  }, {\n    key: \"userHasScopes\",\n    value: function userHasScopes(scopes) {\n      var grantedScopes = (_scopes || \"\").split(\" \");\n\n      return scopes.every(function (scope) {\n        return grantedScopes.includes(scope);\n      });\n    }\n  }, {\n    key: \"renewToken\",\n    value: function renewToken(cb) {\n      var _this2 = this;\n\n      this.auth0.checkSession({}, function (err, result) {\n        if (err) {\n          console.log(\"Error: \".concat(err.error, \" - \").concat(err.error_description, \".\"));\n        } else {\n          _this2.setSession(result);\n        }\n\n        if (cb) cb(err, result);\n      });\n    }\n  }, {\n    key: \"scheduleTokenRenewal\",\n    value: function scheduleTokenRenewal() {\n      var _this3 = this;\n\n      var delay = _expiresAt - Date.now();\n\n      if (delay > 0) setTimeout(function () {\n        return _this3.renewToken();\n      }, delay);\n    }\n  }]);\n\n  return Auth;\n}();\n\nexport { Auth as default };","map":{"version":3,"sources":["/Users/mickjerin/Securing React/src/Auth/Auth.js"],"names":["auth0","REDIRECT_ON_LOGIN","_idToken","_accessToken","_scopes","_expiresAt","Auth","history","login","localStorage","setItem","JSON","stringify","location","authorize","handleAuthentication","parseHash","err","authResult","accessToken","idToken","setSession","redirectLocation","getItem","parse","push","alert","error","console","log","removeItem","expiresIn","Date","getTime","scope","requestedScopes","scheduleTokenRenewal","logout","clientID","process","env","REACT_APP_AUTH0_CLIENT_ID","returnTo","getAccessToken","Error","getProfile","cb","userProfile","client","userInfo","profile","WebAuth","domain","REACT_APP_AUTH0_DOMAIN","redirectUri","REACT_APP_AUTH0_CALLBACK_URL","audience","REACT_APP_AUTH0_AUDIENCE","responseType","scopes","grantedScopes","split","every","includes","checkSession","result","error_description","delay","now","setTimeout","renewToken"],"mappings":"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","sourcesContent":["import auth0 from \"auth0-js\";\n\nconst REDIRECT_ON_LOGIN = \"redirect_on_login\";\n\n// Stored outside class since private\n// eslint-disable-next-line\nlet _idToken = null;\nlet _accessToken = null;\nlet _scopes = null;\nlet _expiresAt = null;\n\nexport default class Auth {\n  constructor(history) {\n    this.history = history;\n    this.userProfile = null;\n    this.requestedScopes = \"openid profile email read:courses\";\n    this.auth0 = new auth0.WebAuth({\n      domain: process.env.REACT_APP_AUTH0_DOMAIN,\n      clientID: process.env.REACT_APP_AUTH0_CLIENT_ID,\n      redirectUri: process.env.REACT_APP_AUTH0_CALLBACK_URL,\n      audience: process.env.REACT_APP_AUTH0_AUDIENCE,\n      responseType: \"token id_token\",\n      scope: this.requestedScopes\n    });\n  }\n\n  login = () => {\n    localStorage.setItem(\n      REDIRECT_ON_LOGIN,\n      JSON.stringify(this.history.location)\n    );\n    this.auth0.authorize();\n  };\n\n  handleAuthentication = () => {\n    this.auth0.parseHash((err, authResult) => {\n      if (authResult && authResult.accessToken && authResult.idToken) {\n        this.setSession(authResult);\n        const redirectLocation =\n          localStorage.getItem(REDIRECT_ON_LOGIN) === \"undefined\"\n            ? \"/\"\n            : JSON.parse(localStorage.getItem(REDIRECT_ON_LOGIN));\n        this.history.push(redirectLocation);\n      } else if (err) {\n        this.history.push(\"/\");\n        alert(`Error: ${err.error}. Check the console for further details.`);\n        console.log(err);\n      }\n      localStorage.removeItem(REDIRECT_ON_LOGIN);\n    });\n  };\n\n  setSession = authResult => {\n    console.log(authResult);\n    // set the time that the access token will expire\n    _expiresAt = authResult.expiresIn * 1000 + new Date().getTime();\n\n    // If there is a value on the `scope` param from the authResult,\n    // use it to set scopes in the session for the user. Otherwise\n    // use the scopes as requested. If no scopes were requested,\n    // set it to nothing\n    _scopes = authResult.scope || this.requestedScopes || \"\";\n\n    _accessToken = authResult.accessToken;\n    _idToken = authResult.idToken;\n    this.scheduleTokenRenewal();\n  };\n\n  isAuthenticated() {\n    return new Date().getTime() < _expiresAt;\n  }\n\n  logout = () => {\n    this.auth0.logout({\n      clientID: process.env.REACT_APP_AUTH0_CLIENT_ID,\n      returnTo: \"http://localhost:3000\"\n    });\n  };\n\n  getAccessToken = () => {\n    if (!_accessToken) {\n      throw new Error(\"No access token found.\");\n    }\n    return _accessToken;\n  };\n\n  getProfile = cb => {\n    if (this.userProfile) return cb(this.userProfile);\n    this.auth0.client.userInfo(this.getAccessToken(), (err, profile) => {\n      if (profile) this.userProfile = profile;\n      cb(profile, err);\n    });\n  };\n\n  userHasScopes(scopes) {\n    const grantedScopes = (_scopes || \"\").split(\" \");\n    return scopes.every(scope => grantedScopes.includes(scope));\n  }\n\n  renewToken(cb) {\n    this.auth0.checkSession({}, (err, result) => {\n      if (err) {\n        console.log(`Error: ${err.error} - ${err.error_description}.`);\n      } else {\n        this.setSession(result);\n      }\n      if (cb) cb(err, result);\n    });\n  }\n\n  scheduleTokenRenewal() {\n    const delay = _expiresAt - Date.now();\n    if (delay > 0) setTimeout(() => this.renewToken(), delay);\n  }\n}\n"]},"metadata":{},"sourceType":"module"}